@page "/malzeme-alt-gruplar"
@inject IMalzemeAltGrupService MalzemeAltGrupService
@inject IMalzemeGrupService MalzemeGrupService
@inject NavigationManager Navigation

<h3>Malzeme Alt Grup Yönetimi</h3>

<EditForm Model="@seciliAltGrup" OnValidSubmit="HandleSubmit">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="row mb-3">
        <div class="col-md-4">
            <label>Malzeme Grup</label>
            <InputSelect class="form-select" @bind-Value="seciliAltGrup.MalzemeGrupId">
                <option value="">-- Seçiniz --</option>
                @foreach (var grup in malzemeGruplar)
                {
                    <option value="@grup.Id">@grup.Ad</option>
                }
            </InputSelect>
        </div>
        <div class="col-md-4">
            <label>Kod</label>
            <InputText class="form-control" @bind-Value="seciliAltGrup.Kod" />
        </div>
        <div class="col-md-4">
            <label>Ad</label>
            <InputText class="form-control" @bind-Value="seciliAltGrup.Ad" />
        </div>
    </div>

    <div class="row mb-3">
        <div class="col-md-2">
            <label>PDF Var</label>
            <InputCheckbox class="form-check-input" @bind-Value="seciliAltGrup.PdfVar" />
        </div>
        <div class="col-md-2">
            <label>DXF Var</label>
            <InputCheckbox class="form-check-input" @bind-Value="seciliAltGrup.DxfVar" />
        </div>
        <div class="col-md-2">
            <label>STEP Var</label>
            <InputCheckbox class="form-check-input" @bind-Value="seciliAltGrup.StepVar" />
        </div>
    </div>

    <button class="btn btn-success" type="submit">@(seciliAltGrup.Id == 0 ? "Ekle" : "Güncelle")</button>
    <button class="btn btn-secondary ms-2" type="button" @onclick="Temizle">Temizle</button>
</EditForm>

<hr />

<table class="table table-bordered table-striped mt-3">
    <thead>
        <tr>
            <th>Kod</th>
            <th>Ad</th>
            <th>Malzeme Grup</th>
            <th>PDF</th>
            <th>DXF</th>
            <th>STEP</th>
            <th>İşlem</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var item in altGruplar)
        {
            <tr>
                <td>@item.Kod</td>
                <td>@item.Ad</td>
                <td>@item.MalzemeGrup?.Ad</td>
                <td>@(item.PdfVar ? "✔" : "-")</td>
                <td>@(item.DxfVar ? "✔" : "-")</td>
                <td>@(item.StepVar ? "✔" : "-")</td>
                <td>
                    <button class="btn btn-sm btn-primary me-1" @onclick="@(() => Duzenle(item))">Düzenle</button>
                    <button class="btn btn-sm btn-danger" @onclick="@(() => Sil(item.Id))">Sil</button>
                </td>
            </tr>
        }
    </tbody>
</table>

<button class="btn btn-outline-dark" @onclick="GeriDon">← Geri</button>

@code {
    private List<MalzemeAltGrup> altGruplar = new();
    private List<MalzemeGrup> malzemeGruplar = new();

    private MalzemeAltGrup seciliAltGrup = new();

    protected override async Task OnInitializedAsync()
    {
        await Yukle();
    }

    private async Task Yukle()
    {
        altGruplar = await MalzemeAltGrupService.GetAllWithIncludeAsync(); // MalzemeGrup navigation dahil!
        malzemeGruplar = await MalzemeGrupService.GetAllAsync();
    }

    private async Task HandleSubmit()
    {
        if (seciliAltGrup.Id == 0)
        {
            await MalzemeAltGrupService.AddAsync(seciliAltGrup);
        }
        else
        {
            await MalzemeAltGrupService.UpdateAsync(seciliAltGrup);
        }

        await Yukle();
        Temizle();
    }

    private void Duzenle(MalzemeAltGrup grup)
    {
        seciliAltGrup = new MalzemeAltGrup
            {
                Id = grup.Id,
                Kod = grup.Kod,
                Ad = grup.Ad,
                PdfVar = grup.PdfVar,
                DxfVar = grup.DxfVar,
                StepVar = grup.StepVar,
                MalzemeGrupId = grup.MalzemeGrupId
            };
    }

    private async Task Sil(int id)
    {
        await MalzemeAltGrupService.DeleteAsync(id);
        await Yukle();
    }

    private void Temizle()
    {
        seciliAltGrup = new();
    }

    private void GeriDon()
    {
        Navigation.NavigateTo("/stok-kart-araclari");
    }
}