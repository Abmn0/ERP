@page "/proje-ekle"
@inherits YektamakWeb.Shared.AuthorizedPageBase
@inject IProjeService ProjeService
@inject IProjeTipService ProjeTipService
@inject IMarkaService MarkaService
@inject IMarkaAltGrupService MarkaAltGrupService
@inject IMarkaAltGrupKategoriService MarkaAltGrupKategoriService
@inject ISatisSiparisService SatisSiparisService
@inject NavigationManager Navigation
@using Models
@using ApiService.Interfaces

<h3>Yeni Proje Ekle</h3>

@if (!ErisimKontrolEdildi)
{
    <p>Sayfa erişimi kontrol ediliyor...</p>
}
else if (!ErisimVar)
{
    <p class="text-danger">Bu sayfaya erişim yetkiniz yok.</p>
}
else
{
    <EditForm Model="@yeniProje" OnSubmit="HandleSubmit">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="mb-3">
            <label>Kod:</label>
            <InputText class="form-control" @bind-Value="yeniProje.Kod" />
        </div>

        <div class="mb-3">
            <label>Ad:</label>
            <InputText class="form-control" @bind-Value="yeniProje.Ad" />
        </div>

        <div class="mb-3">
            <label>Proje Tipi:</label>
            <InputSelect class="form-select" @bind-Value="yeniProje.ProjeTipId">
                <option value="">Seçiniz</option>
                @foreach (var tip in projeTipleri)
                {
                    <option value="@tip.ProjeTipId">@tip.ProjeTipAd</option>
                }
            </InputSelect>
        </div>

        <div class="mb-3">
            <label>Marka:</label>
            <InputSelect class="form-select" @bind-Value="yeniProje.MarkaId">
                <option value="">Seçiniz</option>
                @foreach (var marka in markalar)
                {
                    <option value="@marka.Id">@marka.Ad</option>
                }
            </InputSelect>
        </div>

        <div class="mb-3">
            <label>Alt Grup:</label>
            <InputSelect class="form-select" @bind-Value="yeniProje.AltGrupId">
                <option value="">Seçiniz</option>
                @foreach (var altgrup in altGruplar)
                {
                    <option value="@altgrup.Id">@altgrup.Ad</option>
                }
            </InputSelect>
        </div>

        <div class="mb-3">
            <label>Kategori:</label>
            <InputSelect class="form-select" @bind-Value="yeniProje.KategoriId">
                <option value="">Seçiniz</option>
                @foreach (var kategori in kategoriler)
                {
                    <option value="@kategori.Id">@kategori.Ad</option>
                }
            </InputSelect>
        </div>

        <div class="mb-3">
            <label>Açıklama:</label>
            <InputTextArea class="form-control" @bind-Value="yeniProje.Aciklama" />
        </div>

        <div class="mb-3">
            <label>Sipariş:</label>
            <InputSelect class="form-select" @bind-Value="yeniProje.SatisSiparisId">
                <option value="">Seçiniz</option>
                @foreach (var siparis in satisSiparisler)
                {
                    <option value="@siparis.Id">@siparis.SiparisNo</option>
                }
            </InputSelect>
        </div>

        <button class="btn btn-primary" type="submit">Kaydet</button>
        <button class="btn btn-secondary ms-2" type="button" @onclick="GeriDon">Geri Dön</button>
    </EditForm>
}

@code {
    private Proje yeniProje = new();
    private List<ProjeTip> projeTipleri = new();
    private List<Marka> markalar = new();
    private List<MarkaAltGrup> altGruplar = new();
    private List<MarkaAltGrupKategori> kategoriler = new();
    private List<SatisSiparis> satisSiparisler = new();

    protected override string GercekSayfaYolu => "/proje-ekle";

    protected override async Task OnSayfaYuklendi()
    {
        projeTipleri = await ProjeTipService.GetAllAsync();
        markalar = await MarkaService.GetAllAsync();
        altGruplar = await MarkaAltGrupService.GetAllAsync();
        kategoriler = await MarkaAltGrupKategoriService.GetAllAsync();
        satisSiparisler = await SatisSiparisService.GetAllAsync();
    }

    private async Task HandleSubmit()
    {
        await ProjeService.AddAsync(yeniProje);
        Navigation.NavigateTo("/projeler");
    }


    private void GeriDon()
    {
        Navigation.NavigateTo("/projeler");
    }
}
